# 11. テスト計画

## 単体テスト（XCTest）
- nextResetTime の parse
  - epoch秒 / epochミリ秒 / ISO文字列 / 空
- 使用率計算
  - percentage優先 / usage-number計算
- バックオフ計算
  - factor更新、上限クリップ、ジッター範囲
- ロールバック防止
  - lastKnownResetEpoch から大きく戻る候補は無視
- LoggerManager / DebugLogger
  - ログ出力とフォーマット（ISO8601タイムスタンプ、カテゴリタグ）
  - カテゴリ別ログ抽出
  - ログサイズ制限（100KB）とローテーション
  - ログのクリアとエクスポート

## 結合テスト（手動）
- APIキー未設定
  - UIが設定導線を提示
- 通知許可
  - テスト通知が表示され、通知設定から制御できる
- レート制限模擬
  - QuotaClientをモックし、429/1302等でバックオフが動く
- スリープ復帰
  - 復帰後に状態が継続し、通知が重複しない

---

## Issue #28 Phase 10 受け入れ基準と自動テストのマッピング

| 受け入れ基準 | 対応する自動テスト | テストファイル |
|------------|------------------|---------------|
| 1. 強制終了後、state.jsonから状態が復旧される | `testCrashRecoveryRestoresSnapshot()` | `EdgeCaseIntegrationTests.swift` |
| 2. スリープ復帰時に即時フェッチが実行される | `testWakeFromSleepTriggersImmediateFetch()` | `SleepWakeIntegrationTests.swift` |
| 3. 長時間スリープ後、通知チェックが即座に実行される | `testResetNotifierWakeupIntegration()` | `SleepWakeIntegrationTests.swift` |
| 4. ネットワーク切断時に適切なエラーメッセージが表示される | `testNetworkErrorWithCachedData()` | `EdgeCaseIntegrationTests.swift` |
| 5. usage_cache.json破損時に"no cache"表示がされる | `testCorruptedCacheFileHandledGracefully()` | `EdgeCaseIntegrationTests.swift` |

### 自動テストの実行基準

- すべてのテストがパスすること（`0 failures`）
- テストスキップは許可する（機能依存のテストの場合）

---

## Issue #28 Phase 10 手動テスト手順

### 0. 強制終了後の復旧の確認

**目的**: アプリ強制終了後、起動時にキャッシュされたデータが表示されることを確認

**手順**:
1. アプリを起動し、正常にデータが表示されることを確認
2. アプリを強制終了（Activity Monitorからプロセスを強制終了、または `killall QuotaWatch`）
3. アプリを再起動
4. メニューバーのアイコンをクリック
5. 強制終了前に表示されていたデータが表示されることを確認

**期待結果**:
- アプリが正常に起動する
- キャッシュされたデータが表示される
- エラーメッセージが表示されない

### 1. スリープ復帰の確認

**目的**: スリープ復帰時に即時フェッチが実行され、通知が重複しないことを確認

**手順**:
1. アプリを起動し、メニューバーにアイコンが表示されることを確認
2. システム環境設定 > エネルギー saver で「スリープ」を5分後に設定
3. 5分以上待機してスリープさせる
4. スリープから復帰（キー押下またはマウスクリック）
5. メニューバーのアイコンをクリックし、ステータスを確認
   - 「Last fetch」が復帰直後に更新されていることを確認
   - ログファイル（`~/Library/Application Support/<BundleID>/debug.log`）を確認
   - `[ENGINE] スリープから復帰しました - QuotaEngine` のログを確認
   - 即時フェッチが実行された場合: `[ENGINE] スリープ復帰時: フェッチ時刻到達、即時フェッチを実行します` のログを確認

**期待結果**:
- 復帰直後にデータが更新されている
- 通知が重複して表示されない

### 2. 通知表示の確認

**目的**: クォータリセット時に通知が表示されることを確認

**手順**:
1. システム環境設定 > 通知 で QuotaWatch の通知を許可
2. UIの「Test notification」ボタンをクリック
3. 通知が表示されることを確認

**期待結果**:
- 通知が表示される
- 通知設定から制御できる

### 3. エラー表示の確認

**目的**: ネットワーク切断時に適切なエラーメッセージが表示されることを確認

**手順**:
1. ネットワーク接続を切断（Wi-Fiをオフ、またはイーサネットケーブルを抜く）
2. アプリを起動
3. メニューバーのアイコンをクリック
4. ステータスにエラーメッセージが表示されることを確認

**期待結果**:
- ネットワークエラーのメッセージが表示される
- キャッシュがある場合はキャッシュされたデータが表示される

### 4. キャッシュ破損の確認

**目的**: キャッシュファイル破損時に適切に処理されることを確認

**手順**:
1. アプリを終了
2. 以下のファイルをテキストエディタで開き、内容を破損させる
   - `~/Library/Application Support/<BundleID>/usage_cache.json`
3. アプリを起動
4. メニューバーのアイコンをクリック
5. ステータスに「no cache」または「キャッシュなし」が表示されることを確認

**期待結果**:
- アプリがクラッシュしない
- 適切なエラーメッセージが表示される

---

## Issue #28 Phase 10 受け入れプロセス

### 受け入れチェックリスト

#### 自動テスト

- [ ] すべてのユニットテストがパスする
- [ ] すべての統合テストがパスする
  - [ ] `SleepWakeIntegrationTests` (5テストケース)
  - [ ] `EdgeCaseIntegrationTests` (9テストケース)
- [ ] テスト結果に失敗がないこと（`0 failures`）

#### 手動テスト

- [ ] 強制終了後の復旧の確認
- [ ] スリープ復帰の確認
- [ ] 通知表示の確認
- [ ] エラー表示の確認
- [ ] キャッシュ破損の確認

#### コードレビュー

- [ ] 実装が設計書通りであること
- [ ] エラーハンドリングが適切であること
- [ ] ログ出力が適切であること

### 受け入れ判定基準

- 自動テスト: すべてパス（失敗0）
- 手動テスト: すべての項目が確認完了
- コードレビュー: 重大な問題がないこと

### マージの可否

- すべての受け入れ基準を満たしている場合: マージ可能
- 未解決の問題がある場合: 修正後に再レビュー


